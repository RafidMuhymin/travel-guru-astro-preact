# Welcome to Astro SPA ðŸ‘‹

The Six UI frameworks supported by Astro for templating are primarily used for building SPA. But the application generated by Astro isn't an SPA. And, it's also not possible because Astro turns the component into plain HTML and ships zero JS!

But to enjoy the advantages of an SPA, I have written a tiny script for my personal project that can turn an Astro website into an SPA. It's not only just an SPA component/library but it comes with many other features also.

The complete list of features:

1. It prefetches the internal links using Intersection Observer for blazing-fast navigation
2. It upgrades from prefetch to fetch on mouseover and touchstart if the resource hasn't been prefetched already
3. It caches the prefetched resources using the Cache API
4. It intercepts when you click on an internal link and then it tries to serve the request from cache, if a cache isn't found, it fetches the requested page and replace the current documentElement with the new documentElement
5. It shows a progress bar similar to nprogress
6. The progress bar delays new page load by 100ms to show a 100% completion transition
7. Then it executes the scripts of the navigated page
8. It shows a fade-in animation when the new page loads
9. It also works with popstate events (back/forward navigation)
10. It clears the entire cache on page load/reloads to ensure there's no stale content
11. If data saver is enabled (on mobile devices), it won't fetch or prefetch the pages
12. It dispatches three functions, prefetch, navigate and observe, that can be called for prefetching, navigating and observing an anchor element programmatically
13. It has two lifecycle functions, onNavigate & onMount that can be called to add effects and execute code
14. It provides a helper function, scan()! It can be used for detecting new links and observe them

## Installing the plugin

Once you setup your Astro project simply run the following command:

```bash
# yarn
yarn add astro-spa

# npm
npm i astro-spa
```

You can then import the component like this:

```astro
---
import { Spa } from 'astro-spa'
// or import Spa from 'astro-spa/Spa.astro'
---
<Spa/>
```

And that's it, you're now ready to go!

## APIs

### prefetch

You can use the prefetch function to prefetch links programmatically.

```js
const url = "https://example.com";
prefetch(url);
```

### navigate

You can use the navigate function to trigger in-app navigation programmatically.

```js
const searchQuery = "query";
navigate(`/search?${query}`);
```

### observe

You can use the observe function to start observing a new link programmatically. It'll prefetch and add proper event handlers to the link.

```js
const link = document.querySelector("#new-link");
observe(link); // It will start observing the new link
```

### scan

You can use the scan helper function to start observing all the new links injected later into the document via JS like observe function.

```js
const links = ["a link", "another link", "a third link"];

links.forEach((link) => {
  document.body.appendChild(link);
});
scan(); // It will start observing the new three links
```

### w.onNavigate

You can use the global onNavigate lifecycle function to execute code when the user clicks on an internal link

```js
w.onNavigate = () => {
  console.log("navigated");
};
```

### w.onMount

You can use the global onRender lifecycle function to execute code when the navigated pages has completed loading and executed the scripts. It's an alternative to the DOMContentLoaded or window.load event.

```js
w.onMount = () => {
  console.log("mounted");
};
```

## Configuration Options (Component Props)

### beautify

Type: `boolean`

Default: `false`

Whether or not the code the should be beautified. If true then the code will beautified and if false then the code will be minified using terser.

### cache

Type: `boolean`

Default: `true`

Whether or not Cache API will be used for caching the fetched and prefetched resources.

### delay

Type: `number`

Default: `500`

The amount of time each link needs to stay inside the viewport before being prefetched, in milliseconds.

### external

Type: `boolean`

Default: `false`

Whether the code should be included in an external JavaScript file or be inlined.

### highPriorityPrefetch

Type: `boolean`

Default: `false`

Whether or not the internal links will be prefetched with a higher priority.

### ignores

Type: `array of strings`

Default: `undefined`

The urls that should not be fetched or prefetched. However, they won't be excluded from SPA navigation.

### limit

Type: `number`

Default: `undefined`

The maximum number of links that can be prefetched.

### prefetch

Type: `boolean`

Default: `true`

Whether or not the internal links will be prefetched.

### prefetchUpgradation

Type: `boolean`

Default: `true`

Whether or not the prefetching of the internal links will be upgraded to fetch on mouse over and touch start.

### root

Type: `string`

Default: `undefined`

Example: `"document.querySelector('#viewport')"`

The HTML element to observe for in-viewport links to prefetch. However, the links will be fetched on mouse over and touch start.

### rootMargin

Type: `string`

Default: `undefined`

The CSS margin property that should be respecting when computing intersection.

### threshold

Type: `number`

Default: `0.25`

The percentage of the area of each link that must have entered the viewport to be fetched, in its decimal form (0.25 = 25%).

### timeout

Type: `number`

Default: `2000`

The amount of time in milliseconds the browser must stay idle before executing the script.

## Supported Data Attributes

The script will check if these attributes are present in the element. If present it'll perform the actions respecting them.

### data-spa-ignore

If present, the element won't be observed.

### data-spa-no-prefetch

If present, the link won't be prefetched.

### data-spa-high-priority-prefetch

If present, the link will be prefetched with high priority.

### data-spa-no-prefetch-upgradation

If present, prefetching of the link won't be upgraded to fetch on mouse over and touch start.

## Demos

https://astro-spafy-component-demo.netlify.app/

https://ohka-bots-site-astro-ksoqn4flk7-j2q7uvclm-tc-001.vercel.app/ (Thanks to @Tc-001)

## Upcoming Features

- [ ] Configuration Options
- [ ] A new SPA component that utilizes the new AppHistory API (currently only available in Chrome Canary build)
- [ ] Containerization (Opt-in)
- [ ] You tell me? Create an issue with your wishes
